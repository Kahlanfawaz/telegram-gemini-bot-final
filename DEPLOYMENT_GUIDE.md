# دليل نشر بوت تليجرام على Vercel (الإصدار المحسن)

هذا الدليل يوضح كيفية نشر بوت تليجرام الذي يعمل بتقنية Gemini AI على منصة **Vercel** مجانًا، مع دعم **المحادثات المستمرة (Chat History)** واستخدام سكربت لتعيين **Webhooks** تلقائيًا.

## التحسينات الجديدة

*   **دعم المحادثات المستمرة:** البوت الآن يحفظ سياق المحادثة لكل مستخدم، مما يجعله أكثر ذكاءً في الردود المتتابعة.
*   **إصلاح مشكلة النشر:** تم تعديل الكود لتأجيل تهيئة البوت إلى مرحلة التشغيل، مما يحل مشكلة `InvalidToken` أثناء البناء على Vercel.
*   **سكربت تعيين Webhook:** تم توفير سكربت `set_webhook.py` لتعيين Webhook تلقائيًا، مما يقلل من الأخطاء اليدوية.

## المتطلبات

1.  حساب **GitHub** أو **GitLab** أو **Bitbucket**.
2.  حساب **Vercel** (يمكن التسجيل باستخدام حساب GitHub).
3.  توكن بوت تليجرام (`TELEGRAM_BOT_TOKEN`).
4.  مفتاح Gemini API (`GEMINI_API_KEY`).

# دليل نشر بوت تليجرام على Render (بديل لـ Vercel)

هذا الدليل يوضح كيفية نشر بوت تليجرام الذي يعمل بتقنية Gemini AI على منصة **Render** كبديل لـ Vercel، مع دعم **المحادثات المستمرة (Chat History)** واستخدام سكربت لتعيين **Webhooks** تلقائيًا.

## التحسينات الجديدة

*   **دعم المحادثات المستمرة:** البوت الآن يحفظ سياق المحادثة لكل مستخدم، مما يجعله أكثر ذكاءً في الردود المتتابعة.
*   **إصلاح مشكلة النشر:** تم تعديل الكود لتأجيل تهيئة البوت إلى مرحلة التشغيل، مما يحل مشكلة `InvalidToken` أثناء البناء.
*   **سكربت تعيين Webhook:** تم توفير سكربت `set_webhook.py` لتعيين Webhook تلقائيًا، مما يقلل من الأخطاء اليدوية.
*   **دعم Render:** تم إضافة ملف `Procfile` ومكتبة `gunicorn` لدعم النشر على Render.

## المتطلبات

1.  حساب **GitHub** أو **GitLab** أو **Bitbucket**.
2.  حساب **Render** (يمكن التسجيل باستخدام حساب GitHub).
3.  توكن بوت تليجرام (`TELEGRAM_BOT_TOKEN`).
4.  مفتاح Gemini API (`GEMINI_API_KEY`).

## الخطوة 1: رفع المشروع إلى GitHub

تم رفع الملفات المعدلة إلى المستودع: [https://github.com/Kahlanfawaz/telegram-gemini-bot-vercel](https://github.com/Kahlanfawaz/telegram-gemini-bot-vercel)

## الخطوة 2: النشر على Render

1.  **ربط المستودع:**
    *   سجل الدخول إلى حسابك في Render.
    *   انقر على **"New"** ثم **"Web Service"**.
    *   اختر المستودع `telegram-gemini-bot-final`.
    *   انقر على **"Connect"**.

2.  **تكوين الخدمة:**
    *   **Name:** اختر اسمًا لخدمتك (مثال: `gemini-telegram-bot`).
    *   **Region:** اختر أقرب منطقة لك.
    *   **Branch:** `master` (أو `main`).
    *   **Root Directory:** اتركها فارغة.
    *   **Runtime:** `Python 3`.
    *   **Build Command:** `pip install -r requirements.txt`.
    *   **Start Command:** `gunicorn app:app`.

3.  **إضافة متغيرات البيئة:**
    أضف المتغيرات التالية كمتغيرات بيئة **سرية (Secret Environment Variables)**:

    | الاسم (Name) | القيمة (Value) |
    | :--- | :--- |
    | `TELEGRAM_BOT_TOKEN` | توكن البوت الخاص بك. |
    | `GEMINI_API_KEY` | مفتاح Gemini API الخاص بك. |

4.  **النشر (Create Web Service):**
    *   انقر على **"Create Web Service"**.
    *   انتظر حتى تكتمل عملية النشر. بمجرد الانتهاء، ستحصل على رابط (Domain) لمشروعك (مثال: `https://my-gemini-bot.onrender.com`). **احفظ هذا الرابط.**

## الخطوة 3: تعيين Webhook تلقائيًا (الخطوة الحاسمة)

بدلاً من تعيين Webhook يدويًا، سنستخدم السكربت `set_webhook.py` لضمان الدقة.

1.  **الحصول على رابط Render:**
    افترض أن رابط مشروعك هو: `my-gemini-bot.onrender.com`

2.  **تشغيل السكربت محليًا:**
    قم بتشغيل السكربت `set_webhook.py` على جهازك المحلي (بعد تثبيت المكتبات وتفعيل البيئة الافتراضية) باستخدام متغيرات البيئة التالية:

    ```bash
    # استبدل القيم بقيمك الفعلية
    export TELEGRAM_BOT_TOKEN="YOUR_TELEGRAM_BOT_TOKEN"
    export VERCEL_DOMAIN="YOUR_RENDER_DOMAIN.onrender.com" 
    
    # تأكد من أنك في مجلد المشروع
    python3 set_webhook.py
    ```

    **مثال عملي:**
    ```bash
    export TELEGRAM_BOT_TOKEN="8291744408:AAFZFwOvBBE-X5MIHUzapZ0X5u6_I9fOqkg"
    export VERCEL_DOMAIN="my-gemini-bot.onrender.com" 
    python3 set_webhook.py
    ```

    إذا نجح الأمر، ستحصل على رسالة: `Webhook set successfully!`

## الخطوة 4: اختبار البوت

الآن، يمكنك العودة إلى تليجرام وإرسال رسالة إلى البوت الخاص بك. يجب أن يعمل بشكل مستقر مع حفظ سياق المحادثة.

---
## الخطوة 5: تقليل تأخير الرد (Cold Start)

في الطبقة المجانية من Render، قد تواجه تأخيرًا في الرد الأول بعد فترة من عدم النشاط (Cold Start). لتقليل هذا التأخير، يمكنك استخدام خدمة خارجية لاستدعاء البوت بشكل دوري ومنعه من الدخول في وضع السكون.

1.  **رابط منع السكون (Ping URL):**
    استخدم رابط Render الخاص بك متبوعًا بـ `/ping`.
    **مثال:** `https://<رابط مشروعك على Render>/ping`

2.  **استخدام خدمة خارجية:**
    سجل في خدمة مراقبة مجانية مثل **UptimeRobot** أو **Cron-Job.org**.
    *   قم بإنشاء "Monitor" جديد.
    *   نوع المراقبة: **HTTP(s)**.
    *   الرابط (URL): ضع رابط منع السكون (Ping URL) الذي أنشأته في الخطوة 1.
    *   الفاصل الزمني (Interval): اضبطه على **كل 5 دقائق**.

    هذا سيضمن أن الخادم يستقبل طلبًا كل 5 دقائق، مما يجعله نشطًا دائمًا ويقلل بشكل كبير من تأخير Cold Start.

1.  **ربط المستودع:**
    *   سجل الدخول إلى حسابك في Vercel.
    *   انقر على **"Add New..."** ثم **"Project"**.
    *   اختر المستودع `telegram-gemini-bot-vercel`.
    *   انقر على **"Import"**.

2.  **إضافة متغيرات البيئة:**
    أضف المتغيرات التالية كمتغيرات بيئة **سرية (Secret Environment Variables)**:

    | الاسم (Name) | القيمة (Value) |
    | :--- | :--- |
    | `TELEGRAM_BOT_TOKEN` | توكن البوت الخاص بك. |
    | `GEMINI_API_KEY` | مفتاح Gemini API الخاص بك. |

3.  **النشر (Deploy):**
    *   انقر على **"Deploy"**.
    *   انتظر حتى تكتمل عملية النشر. بمجرد الانتهاء، ستحصل على رابط (Domain) لمشروعك (مثال: `https://my-gemini-bot.vercel.app`). **احفظ هذا الرابط.**

## الخطوة 3: تعيين Webhook تلقائيًا (الخطوة الحاسمة)

بدلاً من تعيين Webhook يدويًا، سنستخدم السكربت `set_webhook.py` لضمان الدقة.

1.  **الحصول على رابط Vercel:**
    افترض أن رابط مشروعك هو: `my-gemini-bot-vercel.vercel.app`

2.  **تشغيل السكربت محليًا:**
    قم بتشغيل السكربت `set_webhook.py` على جهازك المحلي (بعد تثبيت المكتبات وتفعيل البيئة الافتراضية) باستخدام متغيرات البيئة التالية:

    ```bash
    # استبدل القيم بقيمك الفعلية
    export TELEGRAM_BOT_TOKEN="YOUR_TELEGRAM_BOT_TOKEN"
    export VERCEL_DOMAIN="YOUR_VERCEL_DOMAIN.vercel.app" 
    
    # تأكد من أنك في مجلد المشروع
    python3 set_webhook.py
    ```

    **مثال عملي:**
    ```bash
    export TELEGRAM_BOT_TOKEN="8291744408:AAFZFwOvBBE-X5MIHUzapZ0X5u6_I9fOqkg"
    export VERCEL_DOMAIN="my-gemini-bot-vercel.vercel.app" 
    python3 set_webhook.py
    ```

    إذا نجح الأمر، ستحصل على رسالة: `Webhook set successfully!`

## الخطوة 4: اختبار البوت

الآن، يمكنك العودة إلى تليجرام وإرسال رسالة إلى البوت الخاص بك. يجب أن يعمل بشكل مستقر مع حفظ سياق المحادثة.

---
## الخطوة 5: تقليل تأخير الرد (Cold Start)

في الطبقة المجانية من Vercel، قد تواجه تأخيرًا في الرد الأول بعد فترة من عدم النشاط (Cold Start). لتقليل هذا التأخير، يمكنك استخدام خدمة خارجية لاستدعاء البوت بشكل دوري ومنعه من الدخول في وضع السكون.

1.  **رابط منع السكون (Ping URL):**
    استخدم رابط Vercel الخاص بك متبوعًا بـ `/ping`.
    **مثال:** `https://<رابط مشروعك على Vercel>/ping`

2.  **استخدام خدمة خارجية:**
    سجل في خدمة مراقبة مجانية مثل **UptimeRobot** أو **Cron-Job.org**.
    *   قم بإنشاء "Monitor" جديد.
    *   نوع المراقبة: **HTTP(s)**.
    *   الرابط (URL): ضع رابط منع السكون (Ping URL) الذي أنشأته في الخطوة 1.
    *   الفاصل الزمني (Interval): اضبطه على **كل 5 دقائق**.

    هذا سيضمن أن الخادم يستقبل طلبًا كل 5 دقائق، مما يجعله نشطًا دائمًا ويقلل بشكل كبير من تأخير Cold Start.

الآن، يمكنك العودة إلى تليجرام وإرسال رسالة إلى البوت الخاص بك. يجب أن يعمل بشكل مستقر مع حفظ سياق المحادثة.

---
**ملاحظة:** إذا واجهت أي مشاكل، يمكنك دائمًا التحقق من سجلات (Logs) مشروعك على Vercel.
